<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="delegate-ch" content="sec-ch-ua https://guirmannurcence.com; sec-ch-ua-mobile https://guirmannurcence.com; sec-ch-ua-arch https://guirmannurcence.com; sec-ch-ua-model https://guirmannurcence.com; sec-ch-ua-platform https://guirmannurcence.com; sec-ch-ua-platform-version https://guirmannurcence.com; sec-ch-ua-bitness https://guirmannurcence.com; sec-ch-ua-full-version-list https://guirmannurcence.com; sec-ch-ua-full-version https://guirmannurcence.com">
    <style>
        .dtpcnt { opacity: 0; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        a { color: #007bff; text-decoration: none; }
        a:hover { text-decoration: underline; }
        pre { white-space: pre-wrap; font-size: 12px; }
    </style>
    <script>
        (function(c,d,f,h,t,b,n,u,k,l,m,e,p,v,q){function r(a){var c=d.cookie.match(new RegExp("(^| )"+a+"=([^;]+)"));return c?c.pop():f.getItem(a+"-expires")&&+f.getItem(a+"-expires")>(new Date).getTime()?f.getItem(a):null}q="https:"===c.location.protocol?"secure; ":"";c[b]||(c[b]=function(a){c[b].state.callbackQueue.push(a)},c[b].state={callbackQueue:[]},c[b].registerConversion=function(a){c[b].state.callbackQueue.push(a)},function(){(m=/[?&]cpid(=([^&#]*)|&|#|$)/.exec(c.location.href))&&m[2]&&(e=m[2],
p=r("vl-"+e));var a=r("vl-cid"),b;"savedCid"!==u||!a||e&&"undefined"!==typeof e||(b=a);k=d.createElement("script");l=d.scripts[0];k.src=n+(-1===n.indexOf("?")?"?":"&")+"oref="+h(d.referrer)+"&ourl="+h(location[t])+"&opt="+h(d.title)+"&vtm="+(new Date).getTime()+(b?"&cid="+b:"")+(p?"&uw=no":"");l.parentNode.insertBefore(k,l);if(e){a="vl-"+e;b=q;var g=new Date;g.setTime(g.getTime()+864E5);d.cookie=a+"=1; "+b+"samesite=Strict; expires="+g.toGMTString()+"; path=/";f.setItem(a,"1");f.setItem(a+"-expires",
g.getTime())}}())})(window,document,localStorage,encodeURIComponent,"href","dtpCallback","https://guirmannurcence.com/d/.js","savedCid");
    </script>
    <noscript><link href="https://guirmannurcence.com/d/.js?noscript=true&ourl=" rel="stylesheet"/></noscript>
    <title>Офферы</title>
</head>
<body>
    <h1>Доступные офферы</h1>
    <table id="offers-table">
        <thead>
            <tr>
                <th>Оффер</th>
                <th>Полный URL</th>
                <th>Параметры оффера</th>
                <th>Параметры кампании</th>
                <th>Токены посетителя</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    <script>
        dtpCallback((params) => {
            const tableBody = document.querySelector('#offers-table tbody');
            const maxOffers = 50;
            const tokens = dtpCallback.getTokens();

            // Функция для создания строки таблицы
            function createOfferRow(index, redirectUrl) {
                const row = document.createElement('tr');
                
                // Название оффера
                const offerCell = document.createElement('td');
                const a = document.createElement('a');
                a.href = redirectUrl;
                a.textContent = `Оффер ${index === 0 ? 'default' : index}`;
                a.addEventListener('click', () => {
                    dtpCallback.registerClick(index);
                });
                offerCell.appendChild(a);
                row.appendChild(offerCell);

                // Полный URL
                const urlCell = document.createElement('td');
                urlCell.textContent = redirectUrl;
                row.appendChild(urlCell);

                // Параметры оффера (из URL)
                const urlParams = {};
                const url = new URL(redirectUrl);
                for (let [key, value] of url.searchParams.entries()) {
                    urlParams[key] = value;
                }
                const paramsCell = document.createElement('td');
                paramsCell.innerHTML = `<pre>${JSON.stringify(urlParams, null, 2)}</pre>`;
                row.appendChild(paramsCell);

                // Параметры кампании (из params)
                const campaignParams = {
                    'flow.id': params['flow.id'],
                    'lander.id': params['lander.id'],
                    'clickid': params['clickid'],
                    'campaign.id': params['campaign.id'],
                    'trafficsource.id': params['trafficsource.id'],
                    'headline': params['headline'],
                    'beaconUrl': params.links[index] ? params.links[index].beaconUrl : null
                };
                const campaignCell = document.createElement('td');
                campaignCell.innerHTML = `<pre>${JSON.stringify(campaignParams, null, 2)}</pre>`;
                row.appendChild(campaignCell);

                // Токены посетителя
                const tokensCell = document.createElement('td');
                tokensCell.innerHTML = `<pre>${JSON.stringify(tokens, null, 2)}</pre>`;
                row.appendChild(tokensCell);

                return row;
            }

            // Вызываем generateLinks
            dtpCallback.generateLinks();

            // Ждем завершения обработки
            setTimeout(() => {
                let hasValidOffers = false;

                // Проверяем до 50 офферов
                for (let index = 0; index < maxOffers; index++) {
                    const redirectUrl = dtpCallback.getOfferLink(index);
                    if (redirectUrl && !redirectUrl.includes('/click') && params.links[index]) {
                        const row = createOfferRow(index, redirectUrl);
                        tableBody.appendChild(row);
                        hasValidOffers = true;
                    }
                }

                // Если нет валидных офферов, показываем сообщение
                if (!hasValidOffers) {
                    const row = document.createElement('tr');
                    const cell = document.createElement('td');
                    cell.colSpan = 5;
                    cell.textContent = 'Нет доступных офферов. Проверьте конфигурацию в Voluum или наличие валидных redirectUrl в ответе трекера.';
                    row.appendChild(cell);
                    tableBody.appendChild(row);
                }
            }, 1000); // Увеличенная задержка для надежности
        });
    </script>
</body>
</html>
